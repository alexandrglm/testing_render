<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN Panel </title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .file-viewer {
            max-height: 70vh;
            overflow: auto;
        }
    </style>
</head>
<body class="min-h-screen bg-base-100">
    <div class="navbar bg-primary text-primary-content sticky top-0 z-50 shadow-lg">
        <div class="navbar-start">
            <div class="dropdown">
                <label tabindex="0" class="btn btn-ghost lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
                    </svg>
                </label>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52 text-neutral">
                    <li><a onclick="loadModule('dashboard')">Dashboard</a></li>
                    <li><a onclick="loadModule('secrets')">Secrets</a></li>
                    <li><a onclick="loadModule('stats')">Uptime</a></li>
                </ul>
            </div>
            <a class="btn btn-ghost normal-case text-xl">Admin Panel Pro</a>
        </div>
        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a onclick="loadModule('dashboard')">Dashboard</a></li>
                <li><a onclick="loadModule('secrets')">Secrets</a></li>
                <li><a onclick="loadModule('stats')">Uptime</a></li>
            </ul>
        </div>
        <div class="navbar-end">
            <div class="flex items-center gap-4">
                <div class="badge badge-success gap-2">
                    <span id="uptime-display">Loading...</span>
                </div>
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost btn-circle avatar">
                        <div class="w-10 rounded-full bg-neutral-focus">
                            <span class="text-xl">ðŸ‘¤</span>
                        </div>
                    </label>
                    <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                        <li><a onclick="logout()">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <div class="container mx-auto p-4">
        <div id="module-container" class="bg-base-200 rounded-box p-6 shadow-lg">
            <div class="flex justify-center items-center h-64">
                <span class="loading loading-spinner loading-lg"></span>
            </div>
        </div>
    </div>


    <div class="toast toast-bottom toast-end">
        <div class="alert alert-warning" id="session-warning">
            <span>Session expires in: <span id="session-timer">30:00</span></span>
        </div>
    </div>


    <script>


        document.addEventListener('DOMContentLoaded', () => {

            if (typeof Chart === 'undefined') {

                console.error('Chart.js failed to load');

                document.body.innerHTML = `
                    <div class="alert alert-error">
                        Error: Chart.js is bugged!!!
                        <button onclick="window.location.reload()" class="btn btn-sm mt-2">Recargar</button>
                    </div>
                `;
            }
        });
    </script>


    <script>

        const SESSION_TIMEOUT = 1800;
        let sessionTimeLeft = SESSION_TIMEOUT;
        let sessionTimer;
        let charts = {};

        // init
        document.addEventListener('DOMContentLoaded', () => {
            loadModule('dashboard');
            startSessionTimer();
            checkAuthPeriodically();
            updateUptimeDisplay();
        });

        
        // Module Loading
        async function loadModule(moduleName) {
            
            const container = document.getElementById('module-container');
            
            try {
            
                container.innerHTML = '<div class="flex justify-center items-center h-64"><span class="loading loading-spinner loading-lg"></span></div>';
                
                const response = await fetch(`/admin/api/module/${moduleName}_module.html`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Failed to load module');
                
                const html = await response.text();
                container.innerHTML = html;
                
            
                // Execute scripts in the module
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.text = script.text;
                    document.body.appendChild(newScript).parentNode.removeChild(newScript);
                });
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Error loading module: ${error.message}</span>
                    </div>
                `;
                console.error(`Error loading ${moduleName} module:`, error);
            }
        }

        // Session Management
        function startSessionTimer() {
            updateTimerDisplay(sessionTimeLeft);
            
            sessionTimer = setInterval(() => {
                sessionTimeLeft--;
                updateTimerDisplay(sessionTimeLeft);
                
                if (sessionTimeLeft <= 0) {
                    clearInterval(sessionTimer);
                    logout();
                }
                
                if (sessionTimeLeft <= 300) { // 5 minutes
                    document.getElementById('session-warning').classList.add('alert-warning');
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
        
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
        
            document.getElementById('session-timer').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        
        }

        async function checkAuthPeriodically() {
        
            try {
        
                const response = await fetch('/admin/api/check-auth', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Auth check failed');
                
                const data = await response.json();
        
                if (!data.is_admin) {
                    window.location.href = '/admin/login';
        
        
                } else {
        
                    sessionTimeLeft = Math.floor(data.timeout) || SESSION_TIMEOUT;
        
                }
        
        
            } catch (err) {
        
                console.error('Auth check error:', err);
        
            } finally {
        
                setTimeout(checkAuthPeriodically, 30000);
        
            }
        }

        async function logout() {
        
            try {
        
                await fetch('/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/admin/login';
        
            } catch (err) {
        
                console.error('Logout error:', err);
                window.location.href = '/admin/login';
        
            }
        }

        async function updateUptimeDisplay() {
        
            try {
        
                const response = await fetch('/admin/api/system-stats', {
                    credentials: 'include'
                });
        
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('uptime-display').textContent = data.uptime.formatted;
                }
        
        
            } catch (err) {
        
                console.error('Uptime update error:', err);
        
            }
        
            setTimeout(updateUptimeDisplay, 10000);
        
        }

        // Make functions available to modules
        window.loadModule = loadModule;
        window.logout = logout;
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    {% include '_navbar.html' | safe %}
</body>
</html>