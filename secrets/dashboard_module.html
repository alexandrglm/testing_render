<div class="dashboard-container">
    <h2 class="text-2xl font-bold mb-6">ðŸ“Š Server Dashboard</h2>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- CPU -->
        <div class="stat-card card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">CPU Usage</h2>
                <div class="flex items-center gap-4">
                    <div class="radial-progress text-primary" id="cpu-percent" style="--value:0; --size:5rem;">0%</div>
                    <div>
                        <div class="text-sm">Cores: <span id="cpu-cores">0</span></div>
                        <div class="text-sm">Load: <span id="cpu-load">0, 0, 0</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MEM -->
        <div class="stat-card card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Memory</h2>
                <div class="flex items-center gap-4">
                    <div class="radial-progress text-secondary" id="memory-percent" style="--value:0; --size:5rem;">0%</div>
                    <div>
                        <div class="text-sm">Used: <span id="memory-used">0 GB</span></div>
                        <div class="text-sm">Total: <span id="memory-total">0 GB</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DISK -->
        <div class="stat-card card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Disk</h2>
                <div class="flex items-center gap-4">
                    <div class="radial-progress text-accent" id="disk-percent" style="--value:0; --size:5rem;">0%</div>
                    <div>
                        <div class="text-sm">Used: <span id="disk-used">0 GB</span></div>
                        <div class="text-sm">Total: <span id="disk-total">0 GB</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- UPTIMES -->
        <div class="stat-card card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Uptime</h2>
                <div class="flex items-center justify-center h-full">
                    <div class="text-3xl font-bold" id="uptime-display">0d 0h 0m</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CHARTS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">CPU Usage</h2>
                <canvas id="cpu-chart"></canvas>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow">
            <div class="card-body">
                <h2 class="card-title">Memory Usage</h2>
                <canvas id="memory-chart"></canvas>
            </div>
        </div>
    
    </div>
</div>


<script>
(() => {

    let statsInterval;

    function initCharts() {
        const cpuCtx = document.getElementById('cpu-chart')?.getContext('2d');
        const memoryCtx = document.getElementById('memory-chart')?.getContext('2d');

        if (cpuCtx && memoryCtx) {
            window.dashboardCharts = {
                cpu: new Chart(cpuCtx, {
                    type: 'line',
                    data: {
                        labels: Array(20).fill(''),
                        datasets: [{
                            label: 'CPU %',
                            data: Array(20).fill(0),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: { duration: 0 },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                }),
                memory: new Chart(memoryCtx, {
                    type: 'line',
                    data: {
                        labels: Array(20).fill(''),
                        datasets: [{
                            label: 'Memory %',
                            data: Array(20).fill(0),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: { duration: 0 },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                })
            };
        }
    }

    async function loadSystemStats() {
        try {
            const response = await fetch('/admin/api/system-stats', { credentials: 'include' });
            const data = await response.json();

            if (document.getElementById('cpu-percent')) {
                updateStatsUI(data);
                updateCharts(data);
            }
        } catch (err) {
            console.error('Error loading stats:', err);
        }
    }

    function updateStatsUI(data) {
        ['cpu', 'memory', 'disk'].forEach(type => {
            const el = document.getElementById(`${type}-percent`);
            if (el) {
                el.style.setProperty('--value', data[type].percent);
                el.textContent = `${data[type].percent}%`;
            }
        });

        // CPU extra
        document.getElementById('cpu-cores')?.textContent = data.cpu.cores;
        document.getElementById('cpu-load')?.textContent = data.cpu.load.map(x => x.toFixed(1)).join(', ');

        // Memory extra
        document.getElementById('memory-used')?.textContent = `${(data.memory.used / 1024 / 1024 / 1024).toFixed(2)} GB`;
        document.getElementById('memory-total')?.textContent = `${(data.memory.total / 1024 / 1024 / 1024).toFixed(2)} GB`;

        // Disk extra
        document.getElementById('disk-used')?.textContent = `${(data.disk.used / 1024 / 1024 / 1024).toFixed(2)} GB`;
        document.getElementById('disk-total')?.textContent = `${(data.disk.total / 1024 / 1024 / 1024).toFixed(2)} GB`;

        // Uptime
        document.getElementById('uptime-display')?.textContent = data.uptime.formatted;
    }

    function updateCharts(data) {
        if (!window.dashboardCharts) initCharts();

        const cpuChart = window.dashboardCharts.cpu;
        const memoryChart = window.dashboardCharts.memory;

        if (cpuChart && memoryChart) {
            const cpuData = cpuChart.data.datasets[0].data;
            const memData = memoryChart.data.datasets[0].data;

            if (cpuData.length >= 20) {
                cpuData.shift();
                memData.shift();
            }

            cpuData.push(data.cpu.percent);
            memData.push(data.memory.percent);

            cpuChart.update();
            memoryChart.update();
        }
    }

    if (document.getElementById('cpu-chart')) {
        initCharts();
        loadSystemStats();
        statsInterval = setInterval(loadSystemStats, 5000);
    }

    return () => {
        clearInterval(statsInterval);
        if (window.dashboardCharts) {
            window.dashboardCharts.cpu.destroy();
            window.dashboardCharts.memory.destroy();
        }
    };

})();
</script>
