<div class="secrets-container">
    <h2 class="text-2xl font-bold mb-6">üîê Secret Files</h2>
    
    <div class="flex justify-between items-center mb-6">
        <div class="form-control w-full max-w-xs">
            <input type="text" placeholder="Find ...." class="input input-bordered w-full" id="search-secrets">
        </div>
        <button class="btn btn-primary" onclick="loadSecretsList(true)">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            Reload
        </button>
    </div>
    
    <div class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="secrets-list">
                        <tr>
                            <td colspan="4" class="text-center">
                                <span class="loading loading-spinner loading-md"></span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- File viewer -->
    <dialog id="file-modal" class="modal">
        <div class="modal-box max-w-5xl">
            
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
            </form>
            
            <h3 class="font-bold text-lg" id="file-modal-title">Visualizando archivo</h3>
            
            <div class="mt-4">
                <pre class="bg-neutral text-neutral-content p-4 rounded-lg max-h-[70vh] overflow-auto" id="file-modal-content"></pre>
            </div>
        
        </div>
    </dialog>
</div>

<script>
    (() => {

        const fileModal = document.getElementById('file-modal');
        
        // SECRETS
        async function loadSecretsList(forceReload = false) {
            
            const container = document.getElementById('secrets-list');
            
            if (!container) return;

            
            try {
            
                container.innerHTML = '<tr><td colspan="4" class="text-center"><span class="loading loading-spinner loading-md"></span></td></tr>';
                
                const response = await fetch(`/admin/api/secrets-list?${forceReload ? 't=' + Date.now() : ''}`, {
            
                    credentials: 'include'
                });
            
                const data = await response.json();
                
                renderSecretsList(data.secrets);
            
            
            } catch (error) {
            
                console.error('Error loading secrets:', error);
                container.innerHTML = `<tr><td colspan="4" class="text-center text-error">${error.message}</td></tr>`;
            }
        }

        function renderSecretsList(secrets) {

            const container = document.getElementById('secrets-list');

            if (!container) return;

            container.innerHTML = secrets?.length ? secrets.map(file => `
                <tr>
                    <td>${file.name}</td>
                    <td>${file.formatted_size || formatSize(file.size)}</td>
                    <td>${file.formatted_date || new Date(file.modified * 1000).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-xs btn-primary" data-filename="${file.name}">View</button>
                        <button class="btn btn-xs btn-secondary ml-1" data-filename="${file.name}" data-download>Download</button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="text-center">No files</td></tr>';




            container.querySelectorAll('[data-filename]').forEach(btn => {
                
                btn.addEventListener('click', () => {
                
                    if (btn.hasAttribute('data-download')) {
                        downloadSecret(btn.dataset.filename);
                
                
                    } else {
                        viewSecret(btn.dataset.filename);
                    }
                });
            });
        }


        async function viewSecret(filename) {

            try {

                document.getElementById('file-modal-title').textContent = `File: ${filename}`;
                document.getElementById('file-modal-content').textContent = 'Loading...';

                fileModal.showModal();
                
                const response = await fetch(`/admin/api/secrets/${filename}`, { credentials: 'include' });
                document.getElementById('file-modal-content').textContent = await response.text();

            } catch (error) {

                document.getElementById('file-modal-content').textContent = `Error: ${error.message}`;

            }
        }

        // fetch api to direct link

        function downloadSecret(filename) {

            window.open(`/admin/api/secrets/${filename}?download=1`, '_blank');

        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        // Inicializaci√≥n


        if (document.getElementById('secrets-list')) {

            loadSecretsList();

            document.querySelector('button[onclick^="loadSecretsList"]')
                .addEventListener('click', () => loadSecretsList(true));
        }
    })();
</script>
